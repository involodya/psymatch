# Документация по функциям бота

## Архитектура системы

### База данных (database.py)

**Таблицы:**
- `users` - основная информация о пользователях
- `psychologist_profiles` - профили психологов
- `patient_profiles` - профили пациентов  
- `test_results` - результаты психологических тестов
- `matches` - предрасчитанные проценты совместимости
- `likes` - лайки между пользователями
- `user_actions` - лог действий пользователей

### Алгоритм матчинга (matching.py)

**Принцип работы:**
1. Каждый вопрос теста имеет веса (weights) для каждого варианта ответа
2. Ответы пользователя преобразуются в многомерный вектор значений
3. Совместимость рассчитывается через косинусное сходство векторов
4. Результат нормализуется в диапазон 0-100%

**Формула:**
```
similarity = dot_product(v1, v2) / (magnitude(v1) * magnitude(v2))
percentage = ((similarity + 1) / 2) * 100
```

## Сценарии использования

### Сценарий 1: Регистрация пациента

1. Пользователь отправляет `/start`
2. Выбирает "Я пациент"
3. Описывает основной запрос
4. Указывает контакт
5. Проходит психологический тест (10 вопросов)
6. Система автоматически рассчитывает совместимость со всеми психологами

### Сценарий 2: Регистрация психолога

1. Пользователь отправляет `/start`
2. Выбирает "Я психолог"
3. Загружает фото
4. Указывает имя, образование, опыт работы, контакт
5. Проходит психологический тест
6. Система автоматически рассчитывает совместимость со всеми пациентами

### Сценарий 3: Просмотр психологов (пациент)

1. Пациент нажимает "Смотреть психологов"
2. Видит карточку с фото, информацией и процентом совместимости
3. Может листать вперед/назад кнопками ⬅️ и ➡️
4. Может поставить лайк ❤️

### Сценарий 4: Лайк и матч

**Односторонний лайк (пациент -> психолог):**
- Пациент ставит лайк
- Психолог получает уведомление с информацией о пациенте и его контактом

**Взаимный лайк:**
- Если психолог тоже лайкает пациента
- Оба получают уведомление о взаимном матче
- Оба видят контакты друг друга

### Сценарий 5: Просмотр лайков (психолог)

1. Психолог нажимает "Мои лайки"
2. Видит список всех пациентов, которые его лайкнули
3. Для каждого показывается: запрос, совместимость, контакт, дата
4. Взаимные лайки помечены ✅

### Сценарий 6: Статистика (администратор)

1. Администратор нажимает "Статистика"
2. Видит:
   - Количество психологов и пациентов
   - Активных пользователей за 24 часа (отдельно психологи и пациенты)
   - Общее количество созданных пар
   - Количество пар за последние 24 часа

## Логирование и аналитика

### События, которые логируются:

| Событие | Данные | Для аналитики |
|---------|--------|---------------|
| `command_start` | - | Количество новых пользователей |
| `role_selected` | role | Распределение по ролям |
| `card_viewed` | index, psychologist_id, match% | На какой карточке ставят первый лайк |
| `like_sent` | to_user_id, mutual, match% | Средний процент совместимости при лайке |
| `match_created` | with_user_id | Конверсия в матчи |
| `test_answer` | question_idx, answer_idx | Распределение ответов |

### Примеры аналитических запросов:

**На какой по счету карточке в среднем ставят первый лайк:**
```sql
SELECT AVG(CAST(json_extract(action_data, '$.index') AS INTEGER)) 
FROM user_actions 
WHERE action_type = 'card_viewed' 
AND user_id IN (
  SELECT DISTINCT user_id 
  FROM user_actions 
  WHERE action_type = 'like_sent'
);
```

**Средний процент совместимости при лайках:**
```sql
SELECT AVG(CAST(json_extract(action_data, '$.match') AS REAL))
FROM user_actions 
WHERE action_type = 'like_sent';
```

**Конверсия просмотров в лайки:**
```sql
SELECT 
  (SELECT COUNT(*) FROM user_actions WHERE action_type = 'like_sent') * 100.0 / 
  (SELECT COUNT(*) FROM user_actions WHERE action_type = 'card_viewed')
AS conversion_rate;
```

## Кастомизация

### Добавление новых вопросов в тест

В файле `test_questions.json` добавьте объект:
```json
{
  "question": "Ваш вопрос здесь?",
  "options": [
    "Вариант 1",
    "Вариант 2", 
    "Вариант 3",
    "Вариант 4",
    "Вариант 5"
  ],
  "weights": [-1.0, -0.5, 0.0, 0.5, 1.0]
}
```

**Важно:** 
- Всегда 5 вариантов ответа
- Всегда 5 весов (от -1 до 1)
- Веса определяют направление и силу влияния на вектор

### Изменение текстов

Все тексты в `messages.json`. Можно изменить любые сообщения, кнопки, шаблоны.

### Добавление новых функций

**Пример: Добавить возможность редактировать профиль**

1. Добавьте кнопку в `messages.json`:
```json
"button_edit_profile": "✏️ Редактировать профиль"
```

2. Добавьте обработчик в `bot.py`:
```python
async def edit_profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # Ваша логика
    pass
```

3. Зарегистрируйте обработчик:
```python
application.add_handler(MessageHandler(
    filters.Regex("✏️ Редактировать профиль"), 
    edit_profile
))
```

## Безопасность

### Рекомендации:

1. **Не коммитьте `.env` файл** - он содержит токены
2. **Ограничьте доступ к логам** - там есть персональные данные
3. **Регулярно делайте бэкапы БД** - копируйте `psymatch.db`
4. **Используйте HTTPS** для webhook (если будете переходить с polling)

## Масштабирование

При росте количества пользователей:

1. **Оптимизация БД:**
   - Добавьте индексы на часто запрашиваемые поля
   - Периодически очищайте старые записи из `user_actions`

2. **Кэширование:**
   - Кэшируйте результаты совместимости в памяти
   - Используйте Redis для сессий

3. **Асинхронность:**
   - Расчет совместимости можно вынести в фоновую задачу
   - Используйте Celery для тяжелых операций

4. **Миграция на PostgreSQL:**
   - Для больших объемов данных
   - Лучшая поддержка concurrent writes

