# PsyMatch - Telegram Bot для подбора психологов

Бот для матчинга психологов и пациентов на основе психологической совместимости.

## Функционал

### Для пациентов:
- Регистрация с указанием основного запроса
- Прохождение психологического теста
- Просмотр психологов с процентом совместимости
- Навигация вперед/назад по карточкам
- Лайки психологов
- Уведомления о взаимных лайках с контактами

### Для психологов:
- Расширенная регистрация: фото, имя, пол, возраст, образование, о себе, подход, специализации, цена, опыт, контакт
- Прохождение психологического теста (опционально, управляется фича-флагом)
- Получение уведомлений о лайках от пациентов
- Просмотр списка всех лайкнувших пациентов
- Возможность лайкнуть в ответ для создания метча

### Для администраторов:
- Веб-админка на порту 5000 (http://localhost:5000)
- Статистика: количество психологов, пациентов, активных пользователей
- Управление фича-флагами (психологический тест и подбор по совместимости)
- Команда /restart для удаления своего профиля и начала заново

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Создайте `.env` файл на основе `.env.example`:
```bash
cp .env.example .env
```

3. Заполните `.env` файл:
- `BOT_TOKEN` - токен вашего Telegram бота от @BotFather
- `ADMIN_IDS` - ID администраторов через запятую (например: 123456789,987654321)
- `DATABASE_PATH` - путь к файлу базы данных (по умолчанию: psymatch.db)
- `LOG_FILE` - путь к файлу логов (по умолчанию: bot.log)
- `ADMIN_SECRET_KEY` - секретный ключ для Flask-сессий
- `ADMIN_USERNAME` - логин для веб-админки (по умолчанию: admin)
- `ADMIN_PASSWORD` - пароль для веб-админки

4. Примените миграции (для обновления существующей БД):
```bash
python3 migrate_db.py
```

5. Запустите бота:
```bash
python3 bot.py
```

6. (Опционально) Запустите веб-админку:
```bash
python3 admin_app.py
# Откройте http://localhost:5000
```

## Структура проекта

- `bot.py` - главный файл бота с обработчиками
- `database.py` - работа с базой данных SQLite
- `matching.py` - система расчета совместимости
- `messages.json` - все текстовые сообщения бота
- `test_questions.json` - вопросы психологического теста
- `admin_app.py` - веб-админка на Flask
- `migrations/` - версионированные миграции БД
- `templates/` - HTML-шаблоны для веб-админки
- `requirements.txt` - зависимости проекта

## Новые возможности v2.0

### Расширенный профиль психолога
- **Пол**: Мужской / Женский
- **Возраст**: 18-100 лет
- **О себе**: описание ценностей и принципов
- **Подход**: выбор из 8 психологических подходов (КПТ, Психоанализ, Гештальт, и др.)
- **Специализации**: с какими запросами работает (тревога, депрессия, отношения и т.д.)
- **Цена**: 5 вариантов стоимости консультации

### Фича-флаги
Система управления функциональностью через веб-админку:
- `psychological_test_and_matching` - включает/выключает психологический тест и подбор по совместимости
  - **ON**: пользователи проходят тест, психологи сортируются по совместимости
  - **OFF**: тест пропускается, все психологи показываются без учета совместимости

### Веб-админка
- Статистика в реальном времени
- Управление фича-флагами
- Безопасная аутентификация
- Адрес: http://localhost:5000

### Команды бота
- `/start` - начало работы / главное меню
- `/restart` - удалить свой профиль и начать заново

### Админка
- Просмотр всех пользователей с профилями
- Статистика по каждому пользователю (лайки, взаимные пары)
- Блокировка/разблокировка пользователей

### Скрипты
- `python scripts/seed_test_data.py` - заполнить БД тестовыми данными
- `python scripts/clean_database.py` - полная очистка БД
- `pytest tests/` - запустить тесты

## Настройка теста

Вопросы теста находятся в файле `test_questions.json`. Каждый вопрос содержит:
- `question` - текст вопроса
- `options` - варианты ответов (5 вариантов)
- `weights` - веса для каждого ответа (массив из 5 чисел от -1 до 1)

Веса определяют вклад ответа в вектор ценностей пользователя. Совместимость рассчитывается на основе косинусного сходства векторов.

## Тестирование

Запуск тестов:
```bash
pytest tests/
```

Запуск с подробным выводом:
```bash
pytest tests/ -v
```

Запуск конкретного теста:
```bash
pytest tests/test_database.py::test_create_user
```

## Тестовые данные

Для быстрого тестирования можно заполнить БД тестовыми пользователями:

```bash
python scripts/seed_test_data.py
```

Это создаст:
- 3 психологов (ID: 1001, 1002, 1003)
- 2 пациентов (ID: 2001, 2002)
- Несколько тестовых лайков
- Рассчитает совместимость

Для полной очистки БД:

```bash
python scripts/clean_database.py
```

**ВНИМАНИЕ:** Это удалит ВСЕ данные!

## Аналитика

Бот логирует следующие события:
- `command_start` - запуск бота
- `role_selected` - выбор роли (психолог/пациент)
- `patient_request_entered` - ввод запроса пациентом
- `patient_profile_completed` - завершение регистрации пациента
- `psychologist_photo_uploaded` - загрузка фото психологом
- `psychologist_profile_completed` - завершение регистрации психолога
- `test_answer` - ответ на вопрос теста (с номером вопроса и ответа)
- `test_completed` - завершение теста
- `browse_start` - начало просмотра психологов
- `card_viewed` - просмотр карточки (с индексом, ID психолога и процентом совместимости)
- `like_sent` - отправка лайка (с ID получателя, флагом взаимности и процентом совместимости)
- `match_created` - создание взаимного метча
- `view_likes` - просмотр списка лайков
- `view_stats` - просмотр статистики

Все действия логируются в файл `bot.log` и дублируются в консоль.
